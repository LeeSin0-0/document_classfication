如何搭建一个数据仓库，设计规范尤为重要，如果没有定义设计规范，那么这个数仓搭建将会毫无意义，而且可能会适得其反，增加不必要的成本。



# 1. 公共层数据模型架构

## 1.1 设计目标

### 1.1.1 业务目标

将基础数据作为一个基础公共服务，为企业的数据应用和产品提供公共数据服务，帮助数据应用或产品提升获取数据的效率，降低数据加工的深度和复杂度；提升各个产品和应用间的数据一致性。主要包括以下几个方面的内容：

- 将业务系统数据（增量/全量）接入数仓，建立统一、一致、唯一的ODS数据层。
- 实现公共数据业务逻辑的加工和转换
- 实现公共维度下公共数据指标，为上层数据应用服务



### 1.1.2 技术目标

在满足业务的同时，在数据模型设计上，重点以下目标作为i设计时的考量；

- 降成本：模型设计者必须平衡性能和成本要素对数据模型的影响，尤其是在海量的数据情况下，在保障业务和性能的前提下，应该使用合理的数据模型方案和存储策略，尽量消除过渡的数据复制和冗余。
- 提性能：模型设计者需要兼顾模型刷新性能开销、产出时间和访问性能。
- 数据一致性以及数据互通：各个数据模型或者数据表之间保障数据输出的一致性，相同粒度的相同数据项（指标、维度）保持在命名、描述、内容、结构的相对一致性，不同算法的数据项应该显示的通过命名和描述显性化区分。
- 数据质量：数据公共层模型需要尽可能的屏蔽源头的垃圾数据，一方面要保障数据本身的高质量，减少数据缺失、异常、错误等发生；另一方面需要保障业务对应的元数据的高质量。数据有明确的数据含义，为数据使用者提供正确的指引。
- 易用：在保障以上的目标前提下，数据用户能够从业务角度出发快速找到所需的数据，能够较快是掌握模型的适用场景和使用方法；能相对便捷获取数据。

## 1.2 数据架构定义

公共层数据的业务分类架构和数据分类架构如图所示，公共数据划分为两层：

- ODS:主要完成基础数据的接入
- CDM：主要完成公共数据加工与整合，建立一致性维度，构建可复用、面向分析和统计的明细事实表，以及汇总公共粒度指标。

模型架构 - 业务分类架构

![图片](数据仓库模型设计规范.assets/640)



模型架构-数据分类架构

![图片](数据仓库模型设计规范.assets/640)



# 2 公共规范

## 2.1 模型设计基本原则

- 高内聚和低耦合: 一个逻辑和物理模型由哪些记录和字段组成，应该遵循最基本的软件设计方法论的高内聚和低耦合原则。主要从数据的业务特性和访问特性两个角度来考虑；将业务相近或者相关的数据、粒度相同的数据设计为一个逻辑或者物理模型；将高概率同时访问的数据放在一起，将低概率同时访问的数据分开存储。
- 核心模型与扩展模型分离：建立核心模型与扩展模型体系，核心模型包括的字段支持常用核心业务，扩展模型包括的字段支持个性化或者是少量应用的需要，必要时核心模型与扩展模型做关联，不能让扩展字段过度侵入核心模型，破坏核心模型架构的简洁性与可维护性。
- 公共处理逻辑下沉及单一：越是底层公用的处理逻辑更应该在数据调用依赖的底层进行封装与实现，不要让公共的处理逻辑暴露给应用层实现，不要让公共逻辑在多处同时存在。
- 成本与性能平衡：适当的数据冗余换取查询和刷新性能，不宜过度冗余和数据复制。
- 数据可回滚：处理逻辑不变，在不同时间多次运行数据的结果确定不变
- 一致性：相同的字段在不同的表字段名相同。
- 命名清晰可理解：表命名规范需要清晰、一致，表名需要易于下游理解和使用。



## 2.2 层次调用约定

应用层优选调用DW公共层数据，已经存在中间层数据，不允许应用层跨过中间层从ODS层重复加工数据。一方面，中间层调度应该积极了解应用层数据的建设需求，将公用的数据沉淀到公共层，为其他团队提供数据服务；另一方面应用层也需要积极配合中间层团队进行持续的数据公共建设的改造和迁移，。必须避免出现过度的ODS层引用和不合理的数据复制和子集合冗余。

1. ODS层数据不能被应用层任务引用，中间层但愿没有沉淀的 ODS层数据，通过CDM层的视图访问， CDM层视图必须使用调度程序进行封装，保持视图的可维护性与可管理性。
2.  CDM层任务的深度不宜过大（建议不超过10层）
3. 原则上一个计算刷新任务只允许一个输出表，特殊情况除外。
4. 如果多个任务刷新输出一个表（不同任务插入不同的分区），需要建立一个虚拟任务，依赖多个刷新任务，通常情况下游应该依赖此虚拟任务
5.  CDM汇总层优先调用CDM明细层。可累加指标计算， CDM汇总成尽量优先调用已经产出的粗粒度汇总层，避免大量汇总都直接从海量的明细数据层计算。
6.  CDM明细层累积快照事实表优先调用CDM事务型事实表，保持数据的一致性产出。
7. 避免应用层过度引用和依赖CDM层明细数据，有针对性建设好CDM公共汇总

## 2.3 公共层公共字段定义

数据统计日期分区字段

1.按天分区：ds（YYYYMMDD）

2.按小时分区:hh(0~23)

3.按分钟分区：mi（0~59）

4.is_{业务}：表示布尔型数据字段。“Y”,"N"表示，不允许出现空值域

5.原则上不需要冗余分区字段

## 2.4 空值处理原则

- 汇总类指标的空值：空值处理填充为0。
- 维度属性值为空：汇总到对应维度上时，参照不上的统计事实记录行，填充负99
- 未知，再对应围度表有一条-99（未知）的记录。

# 3 命名规范

## 3.1  Ods层命名规范

### 3.1.1 表命名规范

```txt
• 增量数据：{project_name}.s_{源系统表名}_delta

• 全量数据:  {project_name}.s_{源系统表名}

• ODS ETL 过程的临时表：{project_name}.tmp_{临时表所在过程的输出表}_{从 0 开始的序号}

• 按小时的增量表：{project_name}.s_{源系统表名}_{delta}_{hh}

• 按小时的全量表：{project_name}.s_{源系统表名}_{hh}

• 当从不同源系统同步到一个 project 下表命名冲突时，后进来的表的命名加上源系统的dbname。
```

**3.1.2 字段命名规范**

• 字段默认使用源系统字段名称

• 字段名与关键字冲突时处理规则：加一个”_col”后缀，即：源字段名\_col



**3.1.3 数据质量规范**

• 每个 ODS 全量表必须配置唯一性字段标识。

• 每个 ODS 全量表必须做分区空数据监控。

• 建议对重要表的重要枚举类型字段做枚举值变化、及枚举值分布监控。

• 建议对 ODS 表设置数据量及数据记录数做上周同比无变化监控，用于监控源系统下线或者已迁移。

• 每个ODS 层全表都必须要有注释，由数据质量团队推动前台业务系统执行此规范。

**3.2 CDM层命名规范**

**3.2.1 表命名规范**

**明细层设计规范**

{project_name}.dim_{业务 BU/pub}_{维度定义}[_{自定义命名标签}]，所谓的 pub 是类似与具体业务 BU 无关，各个 bu 都可以共用，例如时间维度。例如：

• cdm. dim_tb_item（商品维核心表）

• cdm. dim_tb_item_extend（商品维扩展信息表）

• cdm.dim_tb_item_cate(商品发布类目维表)



{project_name}.dwd_{业务 BU 缩写/pub}_{数据域缩写}_{业务过程缩写}[_{自定义表命名标签缩写}]_{刷新周期标识}_{单分区增量全量标识}

pub 表示数据包括多个 BU 的数据，单分区增量全量标识：i：表示增量，f 表示全量。例如：

• cdm.dwd_tb_trd_ordcrt_trip_di（航旅机票订单下单事实表，日刷新增量）

• cdm.dwd_tb_itm_item_df（商品快照事实表，日刷新全量）

• cdm.dwd_tb_trd_ordcrt_ri(交易下单准实时表，日刷新增量)

**汇总层设计规范**

{project_name}.dws_{业务 BU 缩写/pub}_{数据域缩写}_{数据粒度缩写}[_{自定义表命名标签缩写}]_{统计时间周期范围缩写}[_刷新周期标识][_单分区增量全量标识]。

• cdm.dws_tb_trd_byr_subpay_1d (买家粒度交易分阶段付款一日汇总事实表)

• cdm.dws_tb_trd_byr_subpay_td（买家分阶段付款截至当日汇总表）

• cdm.dws_tb_trd_byr_cod_nd (买家粒度货到付款交易汇总事实表)

• cdm.dws_tb_itm_slr_td (卖家粒度商品截至当日存量汇总表)



3.2.2 数据质量规范

基于维度主键唯一

**4 实表设计准则**

**4.1 事务型事实表设计准则**

事务型事实表主要用于分析行为，追踪事件。事务事实表获取业务过程中的事件或者行为细节，通过事实与维度之间关联，可以非常方便统计各种事件相关的度量，比如交易支付金额，浏览 UV，搜索次数等等。

\1. 基于数据应用需求的分析，如果下游存在较大针对某个业务过程事件的分析指标需求，可以考虑基于某一个事件过程构建事务型事实表。

\2. 事务型事实表一般选用事件发生日期或者时间作为分区字段，可以非常方便下游作业数据扫描执行分区裁剪。

\3. 明细层事实表的冗余子集的原则：有利于降低上层数据访问的 IO 开销

\4. 明细层事实表维度退化到事实表原则：有利于明显减少上层数据访问的 JOIN 成本。

**4.2 周期快照型事实表**

周期性事实表主要用于分析状态型或者存量型事实，快照以预定的时间间隔采样状态度量。比较典型的比如对账户表进行快照，可以非常便捷分析账户日均余额。

**4.3 累计快照事实表**

累计快照事实表是基于多个业务过程联合分析构建的事实表，比如交易的订单，采购单的流转环节等。

累计型快照事实表主要用于分析事件之间的时间间隔与周期，比如交易的支付与发货间隔，分析发货速度，支付和退款环节，分析支付退款率等等；同时也可以用于少量的、且对刷新时间不是非常敏感的指标统计需要，比如交易的关闭和发货，在当前事务型事实表不支持，且只有少量的统计指标，可以基于累计快照事实表计算。



































https://mp.weixin.qq.com/s/g7Rer8isOLo43LxtCC7nQQ























































